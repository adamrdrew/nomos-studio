phase:
  id: 0032
  slug: sky-sector-ceiling-textures
  title: SKY support for sector ceiling textures
  status: complete

steps:
  - id: S001
    title: Locate current sector ceiling texture editing UI
    implemented: true
    reviewed: true
    notes: "Sector editing UI lives in src/renderer/ui/editor/inspector/PropertiesEditor.tsx (SectorEditor). ceil_tex is edited via an HTMLSelect that calls useEditCommitter(...).commitUpdateFields(target, { ceil_tex: next }) which dispatches window.nomos.map.edit with map-edit/update-fields."
    touched:
      - .ushabti/phases/0032-sky-sector-ceiling-textures/progress.yaml

  - id: S002
    title: Define SKY detection helper
    implemented: true
    reviewed: true
    notes: "Added a whitespace/case-insensitive SKY detector in the renderer SectorEditor and derived a showSkybox boolean from sector.ceilTex."
    touched:
      - src/renderer/ui/editor/inspector/PropertiesEditor.tsx
      - .ushabti/phases/0032-sky-sector-ceiling-textures/progress.yaml

  - id: S003
    title: Add “Show Skybox” control to Sector Object Properties
    implemented: true
    reviewed: true
    notes: "Added a Show Skybox radio control (On/Off) to the sector Object Properties UI, driven by the derived showSkybox state. Off is disabled (with inline message) when SKY is active and no textures are indexed."
    touched:
      - src/renderer/ui/editor/inspector/PropertiesEditor.tsx
      - .ushabti/phases/0032-sky-sector-ceiling-textures/progress.yaml

  - id: S004
    title: Implement toggle-on behavior (set ceil_tex to "SKY")
    implemented: true
    reviewed: true
    notes: "Implemented Show Skybox On behavior: toggling On commits { ceil_tex: 'SKY' } via the existing update-fields edit path (no-op if already SKY)."
    touched:
      - src/renderer/ui/editor/inspector/PropertiesEditor.tsx
      - .ushabti/phases/0032-sky-sector-ceiling-textures/progress.yaml

  - id: S005
    title: Implement toggle-off behavior without introducing a dropdown SKY option
    implemented: true
    reviewed: true
    notes: "Implemented Show Skybox Off behavior: when current ceil_tex is SKY, Off commits ceil_tex to the first sorted texture option (same ordering as the dropdown). Off is effectively blocked when no textures exist (radio option disabled + guard)."
    touched:
      - src/renderer/ui/editor/inspector/PropertiesEditor.tsx
      - .ushabti/phases/0032-sky-sector-ceiling-textures/progress.yaml

  - id: S006
    title: Conditionally render the ceiling texture dropdown
    implemented: true
    reviewed: true
    notes: "Ceiling texture dropdown is now only rendered when Show Skybox is Off; SKY mode hides it entirely so the dropdown never needs a synthetic SKY option."
    touched:
      - src/renderer/ui/editor/inspector/PropertiesEditor.tsx
      - .ushabti/phases/0032-sky-sector-ceiling-textures/progress.yaml

  - id: S007
    title: Confirm/implement textured ceiling SKY resolution via map.sky
    implemented: true
    reviewed: true
    notes: "Confirmed textured ceiling SKY handling: SKY ceilings resolve to Images/Sky/<map.sky> and missing/unloadable skies skip fills. Extracted resolveSectorSurfaceTexture helper and updated MapEditorCanvas to use it for consistent SKY resolution." 
    touched:
      - src/renderer/ui/editor/map/resolveSectorSurfaceTexture.ts
      - src/renderer/ui/editor/MapEditorCanvas.tsx
      - .ushabti/phases/0032-sky-sector-ceiling-textures/progress.yaml

  - id: S008
    title: Add/adjust unit tests for SKY (UI + main + rendering helpers) (L04)
    implemented: true
    reviewed: true
    notes: "Added unit coverage for setting sector ceil_tex to 'SKY' (and back) via map-edit/update-fields, and added deterministic branch tests for resolveSectorSurfaceTexture (floor, SKY with sky set, SKY with sky missing, non-SKY ceiling)."
    touched:
      - src/main/application/maps/MapCommandEngine.test.ts
      - src/renderer/ui/editor/map/resolveSectorSurfaceTexture.test.ts
      - .ushabti/phases/0032-sky-sector-ceiling-textures/progress.yaml

  - id: S009
    title: Update documentation (L09)
    implemented: true
    reviewed: true
    notes: "Updated renderer UI documentation to describe Sector Object Properties floor_tex/ceil_tex editing and the new Show Skybox control (SKY commits + dropdown hiding + SKY→Off commits to first texture, with no-textures blocking)."
    touched:
      - docs/renderer-ui-system.md
      - .ushabti/phases/0032-sky-sector-ceiling-textures/progress.yaml

  - id: S010
    title: Verification pass
    implemented: true
    reviewed: true
    notes: "Ran typecheck, lint, and jest; all green."
    touched:
      - .ushabti/phases/0032-sky-sector-ceiling-textures/progress.yaml

  - id: S011
    title: Prevent transient invalid ceiling dropdown state during Skybox toggle
    implemented: true
    reviewed: true
    notes: "Added a local pending-skybox flag so the ceiling dropdown is hidden immediately on toggle-on, and removed the local setCeilTex('SKY') that could temporarily render a <select> with value SKY (not in options). Radios are disabled while the SKY edit is applying."
    touched:
      - src/renderer/ui/editor/inspector/PropertiesEditor.tsx
      - .ushabti/phases/0032-sky-sector-ceiling-textures/progress.yaml

  - id: S012
    title: Ensure Skybox toggle pending state clears on edit failure
    implemented: true
    reviewed: true
    notes: "Changed commitUpdateFields to return a boolean success flag; Skybox On-toggle now clears isSkyboxTogglePending when the edit attempt fails so the UI cannot get stuck and users can retry."
    touched:
      - src/renderer/ui/editor/inspector/PropertiesEditor.tsx
      - .ushabti/phases/0032-sky-sector-ceiling-textures/progress.yaml

  - id: S013
    title: Reset Skybox pending state on selection changes
    implemented: true
    reviewed: true
    notes: "Scoped pending skybox state to the sector id (pendingSkyboxSectorId) and reset it on selection changes; pending UI now only applies to the sector that initiated the edit and cannot leak to newly selected sectors."
    touched:
      - src/renderer/ui/editor/inspector/PropertiesEditor.tsx
      - .ushabti/phases/0032-sky-sector-ceiling-textures/progress.yaml
